<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIæ™ºèƒ½åŠ©æ‰‹</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>ç±»è„‘é€šçŸ¥æ–‡æ¡£æµ‹è¯•</h1>
            <p></p>
        </header>

        <main class="chat-container">
            <div id="chatMessages" class="chat-messages">
                <div class="message ai-message">
                    <div class="message-avatar">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 2L2 7L12 12L22 7L12 2Z"/>
                            <path d="M2 17L12 22L22 17"/>
                            <path d="M2 12L12 17L22 12"/>
                        </svg>
                    </div>
                    <div class="message-content">
                        <div class="welcome-content">
                            <h3>ğŸ‘‹ æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„AIæ™ºèƒ½åŠ©æ‰‹</h3>
                            <p class="welcome-subtitle">æˆ‘ä¼šç›´æ¥å›ç­”ã€å±•ç¤ºæ–‡æ¡£æå–å†…å®¹(é€»è¾‘åœ¨dify)ã€ç›´æ¥ä¸Šä¼ æ–‡æ¡£é—®æˆ‘æ–‡æ¡£ç›¸å…³å†…å®¹ </p>
                          </div>
                    </div>
                </div>
            </div>

            <div class="input-container">
                <div class="mode-selector">
                    <label for="modeSelect">å¯¹è¯æ¨¡å¼ï¼š</label>
                    <select id="modeSelect" class="mode-select">
                        <option value="1">æ­£å¸¸æ²Ÿé€š</option>
                        <option value="2">å±•ç¤ºæå–è¿”å›å†…å®¹</option>
                        <option value="3">ç›´æ¥æµ‹è¯•æ–‡æ¡£è¿”å›</option>
                    </select>
                </div>
                
                <div class="input-wrapper">
                    <div class="input-actions">
                        <button id="uploadButton" class="upload-button" title="ä¸Šä¼ æ–‡æ¡£">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                <polyline points="7 10 12 15 17 10"/>
                                <line x1="12" y1="15" x2="12" y2="3"/>
                            </svg>
                            <span class="upload-badge" id="uploadBadge" style="display: none;">0</span>
                        </button>
                        <input type="file" id="fileInput" class="file-input" accept=".pdf,.doc,.docx,.txt,.md,.json,.csv" multiple>
                    </div>
                    <textarea 
                        id="messageInput" 
                        placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜..." 
                        rows="1"
                        maxlength="4000"
                    ></textarea>
                    <button id="sendButton" class="send-button">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 2L11 13M22 2L15 22L11 13M11 13L2 9"/>
                        </svg>
                    </button>
                </div>
                <div class="input-info">
                    <span class="char-count">0 / 4000</span>
                    <span class="file-count" id="fileCount" style="display: none;">å·²é€‰æ‹© <span id="selectedFileCount">0</span> ä¸ªæ–‡ä»¶</span>
                </div>
                
                <!-- æ–‡ä»¶ä¸Šä¼ å¼¹çª— -->
                <div id="uploadModal" class="upload-modal">
                    <div class="upload-modal-content">
                        <div class="upload-modal-header">
                            <h3>ä¸Šä¼ æ–‡ä»¶</h3>
                            <button class="upload-modal-close" id="uploadModalClose">âœ•</button>
                        </div>
                        <div class="upload-modal-body">
                            <div class="upload-zone" id="uploadZone">
                                <div class="upload-icon">
                                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                        <polyline points="7 10 12 15 17 10"/>
                                        <line x1="12" y1="15" x2="12" y2="3"/>
                                    </svg>
                                </div>
                                <div class="upload-text">
                                    <div class="upload-title">æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„æˆ–ç‚¹å‡»ä¸Šä¼ </div>
                                    <div class="upload-subtitle">æ”¯æŒ PDFã€DOCã€DOCXã€TXTã€MDã€JSONã€CSV ç­‰æ ¼å¼</div>
                                </div>
                                <input type="file" id="fileInputModal" class="file-input" accept=".pdf,.doc,.docx,.txt,.md,.json,.csv" multiple>
                            </div>
                            <div class="upload-progress" id="uploadProgress" style="display: none;">
                                <div class="progress-bar">
                                    <div class="progress-fill" id="progressFill"></div>
                                </div>
                                <span class="progress-text" id="progressText">0%</span>
                            </div>
                            <div class="uploaded-files" id="uploadedFiles" style="display: none;">
                                <div class="files-header">å·²ä¸Šä¼ æ–‡ä»¶ï¼š</div>
                                <div class="files-list" id="filesList"></div>
                            </div>
                        </div>
                        <div class="upload-modal-footer">
                            <button class="upload-modal-btn" id="uploadModalBtn">å®Œæˆä¸Šä¼ </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <div id="thinkingModal" class="thinking-modal">
            <div class="thinking-content">
                <div class="thinking-spinner"></div>
                <p>AIæ­£åœ¨æ€è€ƒä¸­...</p>
            </div>
        </div>
    </div>

    <script>
        const chatMessages = document.getElementById('chatMessages');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const uploadButton = document.getElementById('uploadButton');
        const fileInput = document.getElementById('fileInput');
        const uploadZone = document.getElementById('uploadZone');
        const uploadProgress = document.getElementById('uploadProgress');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const uploadedFiles = document.getElementById('uploadedFiles');
        const filesList = document.getElementById('filesList');
        const fileCount = document.getElementById('fileCount');
        const selectedFileCount = document.getElementById('selectedFileCount');
        const thinkingModal = document.getElementById('thinkingModal');
        const charCount = document.querySelector('.char-count');
        const modeSelect = document.getElementById('modeSelect');
        const uploadModal = document.getElementById('uploadModal');
        const uploadModalClose = document.getElementById('uploadModalClose');
        const uploadModalBtn = document.getElementById('uploadModalBtn');
        const fileInputModal = document.getElementById('fileInputModal');
        const uploadBadge = document.getElementById('uploadBadge');
        
        let uploadedFilesList = [];
        let isUploading = false;

        // æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const icons = {
                'pdf': 'ğŸ“„',
                'doc': 'ğŸ“',
                'docx': 'ğŸ“',
                'txt': 'ğŸ“ƒ',
                'md': 'ğŸ“‹',
                'json': 'ğŸ“Š',
                'csv': 'ğŸ“ˆ'
            };
            return icons[ext] || 'ğŸ“';
        }

        function updateFileList() {
            filesList.innerHTML = '';
            uploadedFilesList.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <div class="file-info">
                        <span class="file-icon">${getFileIcon(file.name)}</span>
                        <span class="file-name" title="${file.name}">${file.name}</span>
                        <span class="file-size">${formatFileSize(file.size)}</span>
                    </div>
                    <span class="file-remove" onclick="removeFile(${index})" title="åˆ é™¤æ–‡ä»¶">âœ•</span>
                `;
                filesList.appendChild(fileItem);
            });

            // æ›´æ–°ä¸Šä¼ æŒ‰é’®çš„å¾½ç« 
            if (uploadedFilesList.length > 0) {
                uploadBadge.textContent = uploadedFilesList.length;
                uploadBadge.style.display = 'flex';
                fileCount.style.display = 'block';
                selectedFileCount.textContent = uploadedFilesList.length;
                uploadedFiles.style.display = 'block';
            } else {
                uploadBadge.style.display = 'none';
                fileCount.style.display = 'none';
                uploadedFiles.style.display = 'none';
            }
        }

        function removeFile(index) {
            uploadedFilesList.splice(index, 1);
            updateFileList();
        }

        function showUploadModal() {
            uploadModal.style.display = 'flex';
        }

        function hideUploadModal() {
            uploadModal.style.display = 'none';
        }

        async function uploadFiles(files) {
            if (isUploading) return;
            
            isUploading = true;
            uploadProgress.style.display = 'flex';
            uploadZone.style.display = 'none';
            
            const formData = new FormData();
            for (let i = 0; i < files.length; i++) {
                formData.append('files', files[i]);
            }

            try {
                const xhr = new XMLHttpRequest();
                
                // è¿›åº¦ç›‘å¬
                xhr.upload.addEventListener('progress', function(e) {
                    if (e.lengthComputable) {
                        const percent = Math.round((e.loaded / e.total) * 100);
                        progressFill.style.width = percent + '%';
                        progressText.textContent = percent + '%';
                    }
                });
                
                // å®Œæˆç›‘å¬
                xhr.addEventListener('load', function() {
                    if (xhr.status === 200) {
                        const result = JSON.parse(xhr.responseText);
                        
                        // å°†ä¸Šä¼ æˆåŠŸçš„æ–‡ä»¶æ·»åŠ åˆ°åˆ—è¡¨
                        result.urls.forEach((url, index) => {
                            uploadedFilesList.push({
                                name: files[index].name,
                                size: files[index].size,
                                url: url
                            });
                        });

                        updateFileList();
                        
                        // é‡ç½®ä¸Šä¼ åŒºåŸŸ
                        uploadProgress.style.display = 'none';
                        uploadZone.style.display = 'block';
                        fileInputModal.value = '';
                        
                        // é‡ç½®è¿›åº¦æ¡
                        progressFill.style.width = '0%';
                        progressText.textContent = '0%';
                    } else {
                        throw new Error('ä¸Šä¼ å¤±è´¥');
                    }
                });
                
                // é”™è¯¯ç›‘å¬
                xhr.addEventListener('error', function() {
                    throw new Error('ç½‘ç»œé”™è¯¯');
                });
                
                // å‘é€è¯·æ±‚
                xhr.open('POST', '/upload', true);
                xhr.send(formData);
                
            } catch (error) {
                console.error('ä¸Šä¼ å¤±è´¥:', error);
                uploadProgress.style.display = 'none';
                uploadZone.style.display = 'block';
                alert('æ–‡ä»¶ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•');
                
                // é‡ç½®è¿›åº¦æ¡
                progressFill.style.width = '0%';
                progressText.textContent = '0%';
            } finally {
                isUploading = false;
            }
        }

        // æ–‡ä»¶é€‰æ‹©äº‹ä»¶
        fileInputModal.addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            if (files.length > 0) {
                uploadFiles(files);
            }
        });

        // ä¸Šä¼ æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        uploadButton.addEventListener('click', function() {
            showUploadModal();
        });

        // å¼¹çª—å…³é—­äº‹ä»¶
        uploadModalClose.addEventListener('click', function() {
            hideUploadModal();
        });

        uploadModalBtn.addEventListener('click', function() {
            hideUploadModal();
        });

        // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
        uploadModal.addEventListener('click', function(e) {
            if (e.target === uploadModal) {
                hideUploadModal();
            }
        });

        // æ‹–æ‹½ä¸Šä¼ 
        uploadZone.addEventListener('click', function() {
            fileInputModal.click();
        });

        uploadZone.addEventListener('dragover', function(e) {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });

        uploadZone.addEventListener('dragleave', function(e) {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
        });

        uploadZone.addEventListener('drop', function(e) {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            
            const files = Array.from(e.dataTransfer.files);
            const validFiles = files.filter(file => {
                const validTypes = ['.pdf', '.doc', '.docx', '.txt', '.md', '.json', '.csv'];
                const ext = '.' + file.name.split('.').pop().toLowerCase();
                return validTypes.includes(ext);
            });

            if (validFiles.length > 0) {
                uploadFiles(validFiles);
            } else {
                alert('è¯·ä¸Šä¼ æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ï¼šPDFã€DOCã€DOCXã€TXTã€MDã€JSONã€CSV');
            }
        });

        // è‡ªåŠ¨è°ƒæ•´textareaé«˜åº¦
        messageInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            
            // æ›´æ–°å­—ç¬¦è®¡æ•°
            charCount.textContent = `${this.value.length} / 4000`;
        });

        // å‘é€æ¶ˆæ¯
        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message && uploadedFilesList.length === 0) return;

            // è·å–ä¸Šä¼ æ–‡ä»¶çš„URL
            const fileUrls = uploadedFilesList.map(file => file.url);
            
            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            let userMessage = message;
            if (uploadedFilesList.length > 0) {
                const fileNames = uploadedFilesList.map(file => file.name).join(', ');
                userMessage += `\n\nğŸ“ é™„ä»¶: ${fileNames}`;
            }
            addMessage(userMessage, 'user');
            
            // æ¸…ç©ºè¾“å…¥æ¡†å’Œæ–‡ä»¶åˆ—è¡¨
            messageInput.value = '';
            messageInput.style.height = 'auto';
            charCount.textContent = '0 / 4000';
            uploadedFilesList = [];
            updateFileList();
            
            // åˆ›å»ºAIæ¶ˆæ¯å®¹å™¨
            const aiMessageDiv = document.createElement('div');
            aiMessageDiv.className = 'message ai-message';
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.innerHTML = `
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2L2 7L12 12L22 7L12 2Z"/>
                    <path d="M2 17L12 22L22 17"/>
                    <path d="M2 12L12 17L22 12"/>
                </svg>
            `;
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            
            const thinkDiv = document.createElement('div');
            thinkDiv.className = 'think-content';
            thinkDiv.style.display = 'none';
            
            // åˆ›å»ºæŠ˜å å¼çš„thinkå†…å®¹
            const thinkHeader = document.createElement('div');
            thinkHeader.className = 'think-header';
            thinkHeader.innerHTML = '<strong>ğŸ¤” æ€è€ƒå†…å®¹</strong><span class="think-toggle">â–¼</span>';
            
            const thinkBody = document.createElement('div');
            thinkBody.className = 'think-body';
            thinkBody.style.display = 'none';
            
            thinkDiv.appendChild(thinkHeader);
            thinkDiv.appendChild(thinkBody);
            
            // åªåˆ›å»ºç­”æ¡ˆæ˜¾ç¤ºåŒºåŸŸï¼Œä¸åˆ›å»ºé¢å¤–çš„æ®µè½
            const answerDisplay = document.createElement('div');
            answerDisplay.style.whiteSpace = 'pre-wrap';
            answerDisplay.style.wordWrap = 'break-word';
            answerDisplay.innerHTML = '';
            
            // æ·»åŠ æ€è€ƒçŠ¶æ€æŒ‡ç¤ºå™¨
            const thinkingIndicator = document.createElement('div');
            thinkingIndicator.className = 'thinking-indicator';
            thinkingIndicator.innerHTML = `
                <div class="thinking-dots">
                    <div class="thinking-dot"></div>
                    <div class="thinking-dot"></div>
                    <div class="thinking-dot"></div>
                </div>
                <div class="thinking-text">AIæ­£åœ¨æ€è€ƒä¸­...</div>
            `;
            
            // æ·»åŠ æµå¼åŠ è½½æŒ‡ç¤ºå™¨
            const streamLoadingIndicator = document.createElement('div');
            streamLoadingIndicator.className = 'stream-loading-indicator';
            streamLoadingIndicator.innerHTML = `
                <div class="stream-loading-dots">
                    <div class="stream-loading-dot"></div>
                    <div class="stream-loading-dot"></div>
                    <div class="stream-loading-dot"></div>
                </div>
                <div class="stream-loading-text">æ­£åœ¨æ¥æ”¶å“åº”...</div>
            `;
            
            messageContent.appendChild(thinkDiv);
            messageContent.appendChild(thinkingIndicator);
            messageContent.appendChild(streamLoadingIndicator);
            messageContent.appendChild(answerDisplay);
            
            // æ·»åŠ ç‚¹å‡»äº‹ä»¶
            thinkHeader.addEventListener('click', function() {
                const isExpanded = thinkBody.style.display !== 'none';
                thinkBody.style.display = isExpanded ? 'none' : 'block';
                thinkDiv.querySelector('.think-toggle').textContent = isExpanded ? 'â–¼' : 'â–²';
            });
            aiMessageDiv.appendChild(avatar);
            aiMessageDiv.appendChild(messageContent);
            
            chatMessages.appendChild(aiMessageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            try {
                console.log('Sending message:', message);
                const requestData = {
                    query: message,
                    user: 'user-' + Date.now(),
                    inputs: {
                        classification: modeSelect.value
                    }
                };
                
                // å¦‚æœæœ‰æ–‡ä»¶URLï¼Œæ·»åŠ åˆ°è¯·æ±‚ä¸­
                if (fileUrls.length > 0) {
                    requestData.inputs.url = fileUrls[0];
                }
                
                // åˆå§‹åªæ˜¾ç¤ºæ€è€ƒæŒ‡ç¤ºå™¨
                thinkingIndicator.style.display = 'flex';
                streamLoadingIndicator.style.display = 'none';
                
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                console.log('Response status:', response.status);
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let thinkContent = '';
                let answerContent = '';
                let thinkDisplayBuffer = '';
                let answerDisplayBuffer = '';
                let isInThink = false;
                let thinkTagBuffer = '';
                let answerTagBuffer = '';
                
                console.log('Starting to read stream...');
                
                // æ€è€ƒæŒ‡ç¤ºå™¨ä¿æŒæ˜¾ç¤ºï¼Œç­‰å¾…å®é™…å†…å®¹åˆ°è¾¾
                
                // æ·»åŠ è¶…æ—¶å¤„ç†
                const timeout = setTimeout(() => {
                    if (thinkingIndicator.style.display !== 'none' || streamLoadingIndicator.style.display !== 'none') {
                        thinkingIndicator.style.display = 'none';
                        streamLoadingIndicator.style.display = 'none';
                        answerDisplay.innerHTML = '<span style="color: #ef4444;">è¯·æ±‚è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•</span>';
                    }
                }, 30000); // 30ç§’è¶…æ—¶
                
                // åˆ›å»ºæ‰“å­—æœºæ•ˆæœçš„æ˜¾ç¤ºå…ƒç´ 
                const thinkDisplay = document.createElement('pre');
                thinkDisplay.style.whiteSpace = 'pre-wrap';
                thinkDisplay.style.wordWrap = 'break-word';
                thinkDisplay.style.margin = '0';
                thinkDisplay.style.fontFamily = 'inherit';
                thinkBody.innerHTML = '';
                thinkBody.appendChild(thinkDisplay);
                
                // answerDisplay å·²ç»åœ¨ä¸Šé¢åˆ›å»ºäº†ï¼Œç›´æ¥ä½¿ç”¨
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) {
                        break;
                    }
                    
                    const chunk = decoder.decode(value);
                    console.log('Received chunk:', chunk);
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.slice(6);
                            if (data === '[DONE]') {
                                continue;
                            }
                            
                            try {
                                const parsed = JSON.parse(data);
                                console.log('Parsed data:', parsed);
                                
                                // æ”¶åˆ°ä»»ä½•å“åº”æ—¶åˆ‡æ¢åˆ°æµå¼åŠ è½½æŒ‡ç¤ºå™¨
                                if (thinkingIndicator.style.display !== 'none') {
                                    thinkingIndicator.style.display = 'none';
                                    streamLoadingIndicator.style.display = 'flex';
                                }
                                
                                // å¤„ç†æ€è€ƒå†…å®¹çš„æµå¼è¾“å‡º
                                if (parsed.type === 'thinking_stream' && parsed.thinking && parsed.thinking.trim()) {
                                    // ç´¯ç§¯æ€è€ƒå†…å®¹ï¼Œå®ç°çœŸæ­£çš„æµå¼æ•ˆæœ
                                    thinkDisplayBuffer += parsed.thinking;
                                    thinkDisplay.textContent = thinkDisplayBuffer;
                                    thinkDiv.style.display = 'block';
                                    
                                    // æ€è€ƒå†…å®¹æ˜¾ç¤ºæ—¶ç¡®ä¿å·²åˆ‡æ¢åˆ°æµå¼åŠ è½½æŒ‡ç¤ºå™¨
                                    
                                    console.log('æ€è€ƒå†…å®¹æµå¼æ›´æ–°ï¼Œå½“å‰é•¿åº¦:', thinkDisplayBuffer.length);
                                    console.log('æ€è€ƒå†…å®¹ç‰‡æ®µ:', parsed.thinking.substring(0, 50) + '...');
                                    
                                    // å¦‚æœæ˜¯å®Œæ•´çš„æ€è€ƒå†…å®¹ï¼Œå®Œæˆåé»˜è®¤æŠ˜å 
                                    if (parsed.is_complete) {
                                        thinkBody.style.display = 'none';  // å®ŒæˆåæŠ˜å 
                                        thinkDiv.querySelector('.think-toggle').textContent = 'â–¼';  // æŠ˜å çŠ¶æ€
                                        console.log('æ€è€ƒå†…å®¹å‘é€å®Œæˆï¼Œå·²æŠ˜å ');
                                    } else {
                                        // åœ¨æµå¼ä¼ è¾“è¿‡ç¨‹ä¸­ä¿æŒå±•å¼€
                                        thinkBody.style.display = 'block';
                                        thinkDiv.querySelector('.think-toggle').textContent = 'â–²';
                                    }
                                }
                                
                                // å¤„ç†ç­”æ¡ˆå†…å®¹çš„æµå¼è¾“å‡º
                                if (parsed.type === 'message' && parsed.answer && parsed.answer.trim()) {
                                    // ç´¯ç§¯ç­”æ¡ˆå†…å®¹ï¼Œå®ç°çœŸæ­£çš„æµå¼æ•ˆæœ
                                    answerDisplayBuffer += parsed.answer;
                                    answerDisplay.innerHTML = answerDisplayBuffer.replace(/\n/g, '\u003cbr\u003e');
                                    
                                    // ç­”æ¡ˆå†…å®¹æ˜¾ç¤ºæ—¶ç¡®ä¿å·²åˆ‡æ¢åˆ°æµå¼åŠ è½½æŒ‡ç¤ºå™¨
                                    
                                    // æ»šåŠ¨åˆ°åº•éƒ¨
                                    chatMessages.scrollTop = chatMessages.scrollHeight;
                                    
                                    console.log('ç­”æ¡ˆå†…å®¹æµå¼æ›´æ–°ï¼Œå½“å‰é•¿åº¦:', answerDisplayBuffer.length);
                                }
                            } catch (e) {
                                console.log('JSON parse error:', e);
                            }
                        }
                    }
                }
                
                // æµå¼æ¥æ”¶ç»“æŸåï¼Œç¡®ä¿æ‰€æœ‰å†…å®¹æ˜¾ç¤ºæ­£ç¡®
                if (thinkDisplayBuffer.trim()) {
                    thinkDisplay.textContent = thinkDisplayBuffer;
                    thinkDiv.style.display = 'block';
                    thinkBody.style.display = 'none';
                    thinkDiv.querySelector('.think-toggle').textContent = 'â–¼';
                } else {
                    thinkDiv.style.display = 'none';
                }
                
                if (answerDisplayBuffer.trim()) {
                    answerDisplay.innerHTML = answerDisplayBuffer.replace(/\n/g, '\u003cbr\u003e');
                }
                
                // éšè—æµå¼åŠ è½½æŒ‡ç¤ºå™¨
                streamLoadingIndicator.style.display = 'none';
                
                // æ¸…é™¤è¶…æ—¶å®šæ—¶å™¨
                clearTimeout(timeout);
                
            } catch (error) {
                // æ¸…é™¤è¶…æ—¶å®šæ—¶å™¨
                clearTimeout(timeout);
                // éšè—æ‰€æœ‰åŠ è½½æŒ‡ç¤ºå™¨
                thinkingIndicator.style.display = 'none';
                streamLoadingIndicator.style.display = 'none';
                answerDisplay.innerHTML = '<span style="color: #ef4444;">ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•</span>';
            }
        }

        // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©ç•Œé¢
        function addMessage(content, type, isError = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}-message`;
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = type === 'user' ? 'æˆ‘' : 'AI';
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            
            const paragraph = document.createElement('p');
            paragraph.textContent = content;
            if (isError) {
                paragraph.style.color = '#ef4444';
            }
            
            messageContent.appendChild(paragraph);
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(messageContent);
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // æ·»åŠ AIæ¶ˆæ¯ï¼ˆåŒ…å«thinkå†…å®¹ï¼‰
        function addAIMessage(answer, think) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message ai-message';
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = 'AI';
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            
            // å¦‚æœæœ‰thinkå†…å®¹ï¼Œå…ˆæ˜¾ç¤ºthink
            if (think) {
                const thinkDiv = document.createElement('div');
                thinkDiv.className = 'think-content';
                thinkDiv.innerHTML = `<strong>æ€è€ƒè¿‡ç¨‹ï¼š</strong><pre>${think}</pre>`;
                messageContent.appendChild(thinkDiv);
            }
            
            // æ·»åŠ å›ç­”å†…å®¹
            const paragraph = document.createElement('p');
            paragraph.innerHTML = answer.replace(/\n/g, '<br>');
            messageContent.appendChild(paragraph);
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(messageContent);
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // å‘é€æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        sendButton.addEventListener('click', sendMessage);

        // å›è½¦å‘é€æ¶ˆæ¯
        messageInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // åˆå§‹åŒ–å­—ç¬¦è®¡æ•°
        charCount.textContent = '0 / 4000';
    </script>
</body>
</html>